generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "mongodb"
  url      = env("DATABASE_URL")
}

model User {
  id       String         @id @default(auto()) @map("_id") @db.ObjectId
  name     String
  image    String
  email    String         @unique
  phone    String
  password String
  role     UserRoleEnum   @default(USER)
  status   UserStatusEnum @default(DEACTIVATE)

  fcmToken    String?
  isVerified  Boolean   @default(false)
  // customerId      String?
  // stripeAccountId String?
  lastLoginAt DateTime?
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  // Chat Relations
  chatRooms      ChatRoom[] @relation("ChatRoomUsers", fields: [chatRoomIds], references: [id])
  chatRoomIds    String[]   @db.ObjectId
  messagesSent   Message[]  @relation("sender")
  adminChatRooms ChatRoom[] @relation("admin")

  notificationsSent     Notification[] @relation("sender")
  notificationsReceived Notification[] @relation("receiver")

  @@map("users")
}

model Notification {
  id         String               @id @default(auto()) @map("_id") @db.ObjectId
  senderId   String?              @db.ObjectId
  sender     User?                @relation("sender", fields: [senderId], references: [id])
  receiverId String               @db.ObjectId
  receiver   User                 @relation("receiver", fields: [receiverId], references: [id])
  title      String
  body       String
  type       NotificationTypeEnum @default(NOTIFY) // MESSAGE , FRIEND_REQUEST, SYSTEM_ALERT, NOTIFY
  isRead     Boolean              @default(false)
  createdAt  DateTime             @default(now())

  @@index([senderId, isRead])
  @@index([receiverId, isRead])
  @@map("notifications")
}

enum NotificationTypeEnum {
  NOTIFY
}

// model RefreshToken {
//   id        String   @id @default(auto()) @map("_id") @db.ObjectId
//   userId    String   @db.ObjectId
//   user      User     @relation(fields: [userId], references: [id])
//   token     String   @unique
//   createdAt DateTime @default(now())
//   expiresAt DateTime

//   @@index([userId, expiresAt])
//   @@map("refresh_tokens")
// }

// Chat Models
model ChatRoom {
  id        String       @id @default(auto()) @map("_id") @db.ObjectId
  users     User[]       @relation("ChatRoomUsers", fields: [userIds], references: [id])
  userIds   String[]     @db.ObjectId
  messages  Message[]
  type      ChatRoomType @default(PRIVATE)
  name      String?
  adminId   String?      @db.ObjectId
  admin     User?        @relation("admin", fields: [adminId], references: [id])
  createdAt DateTime     @default(now())
  updatedAt DateTime     @updatedAt

  @@map("chat_rooms")
}

model Message {
  id         String   @id @default(auto()) @map("_id") @db.ObjectId
  chatRoomId String   @db.ObjectId
  chatRoom   ChatRoom @relation(fields: [chatRoomId], references: [id])
  senderId   String   @db.ObjectId
  sender     User     @relation("sender", fields: [senderId], references: [id])
  content    String?
  images     String[]
  isRead     Boolean  @default(false)
  readBy     String[] @db.ObjectId
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  @@index([chatRoomId, senderId])
  @@map("messages")
}

enum ChatRoomType {
  PRIVATE
  GROUP
}

model Otp {
  id        String      @id @default(auto()) @map("_id") @db.ObjectId
  email     String
  code      String
  type      OtpTypeEnum //  VERIFY_EMAIL, RESET_PASSWORD, VERIFY_PHONE,
  createdAt DateTime    @default(now())
  expiresAt DateTime

  @@unique([email, code, type])
  @@index([email, type, expiresAt])
  @@map("opts")
}

// Enums
enum OtpTypeEnum {
  LOGIN
  FORGOT_PASSWORD
  VERIFY_EMAIL
  RESET_PASSWORD
  VERIFY_PHONE
  VERIFY_USER
}

enum UserRoleEnum {
  USER
  ADMIN
  MODERATOR
}

enum UserStatusEnum {
  DEACTIVATE
  ACTIVE
  BLOCKED
}
